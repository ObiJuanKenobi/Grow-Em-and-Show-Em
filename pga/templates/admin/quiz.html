{% include "admin/header.html" %}

<style>
	.correct {
		color: green;
	}
	
	.questionTextEdit, .answerEdit, .correctOption {
		display:none;
	}
</style>

<script type='text/javascript'>

    
    function saveChangedQuestions(){
        //Save was pressed, find text that changed and update DB
        $("#questionsDiv div").each(function() {
            var id = $(this).attr('id');
            id = id.replace("question", ""); // Turns 'question19' into '19'
            var originalText = $(this).find(".questionText").text().trim();
            var editedText = String($(this).find(".questionTextEdit").val()).trim();
            
            if(originalText !== editedText){
                alert("New question: " + editedText + ", " + originalText + ", " + id);
                
                updateQuestion(id, editedText);
            }
            
            $(this).find("ol li").each(function() {
                var answerId = $(this).attr('id');
                answerId = answerId.replace("answer", "");
                var originalAnswer = $(this).find(".answer").text().trim();
                var editedAnswer = String($(this).find(".answerEdit").val()).trim();
                var name = 'correct' + id;
                var isCorrect = $(this).find("input[name=" + name + "]").is(":checked");
                var wasCorrect = $(this).find("span").hasClass("correct");
                
                if(originalAnswer !== editedAnswer){
                    alert("New answer: " + editedAnswer + " , id: " + answerId + ", isCorrect: " + isCorrect);
                    updateAnswer(answerId, editedAnswer, isCorrect);
                }
                else if( isCorrect !== wasCorrect){
                    alert("Answer didn't change, but correctness did");
                    updateAnswer(answerId, editedAnswer, isCorrect);
                }
                
                
            });
        });
    }
    
    function updateQuestion(id, editedText){
        $.ajax({
            url: "/pgaadmin/quiz/editQuestion",
            type: "POST",
            data: {
                questionid: id,
                newquestion: editedText
            },
            success: function (data) {
                alert("Success!");
                console.log(data);
            },
            error: function (xhr, errmsg, err) {
                alert("Error: " + errmsg);
                console.log(errmsg);
            }
        });
    }
    
    function updateAnswer(answerId, newAnswer, isCorrect){
        $.ajax({
            url: "/pgaadmin/quiz/editAnswer",
            type: "POST",
            data: {
                answerid: answerId,
                newanswer: newAnswer,
                iscorrect: isCorrect
            },
            success: function (data) {
                alert("Success!");
                console.log(data);
            },
            error: function (xhr, errmsg, err) {
                alert("Error: " + errmsg);
                console.log(errmsg);
            }
        });
    }

	var editing = false;
	var uploadDialog;
    var fileUploadId;
	
	var uploadNewQuizFile = function() {
		var file = document.getElementById(fileUploadId).files[0];
		//alert(file.name);
		
		var uploadType = $('input[name=uploadType]:checked').val();
		//alert(uploadType);
        
        $("#uploadForm").submit();
		
		uploadDialog.dialog("close");
	}
	
	$(function() {
    
        setupCSRF();
        fileUploadId = $("#fileUploadId").val();		
	
		uploadDialog = createUploadDialog(fileUploadId);
			
		$("#uploadListBtn").click(function(){
			uploadDialog.dialog("open");
		});
		
		$("#editBtn").click(function() {
		
			$(".questionText").toggle();
			$(".questionTextEdit").toggle();
			$(".answerEdit").toggle();
			$(".answer").toggle();
			$(".correctOption").toggle();
			
			editing = !editing;
			
			if(editing){
				$("#editBtn").text('Save');
			}
			else {
				$("#editBtn").text('Edit');
				
				saveChangedQuestions();
			}
		});
		
	});
</script>

<span class='adminPageTitle'>{{ unit }} Quiz</span>&nbsp; &nbsp;<a class='backLink' href='/pgaadmin/unit/{{unit}}'>Back</a><br><br>

<div class='content'>
	<button id='editBtn'>Edit</button>&nbsp;
	<button id='addBtn'>Add Question</button>&nbsp;
	<button id='uploadListBtn'>Upload New Question List</button><br><br>
    
    {% include "admin/upload_status.html" %}
	
	<div id='questionsDiv'>
	{% for q in questions %}
		
		<div class='questionDiv' id='question{{ q.id }}'>
		<b>Question {{ forloop.counter }} </b> <span class='questionText'>{{ q.question }}</span>
			<input type='text' class='questionTextEdit' value='{{ q.question }}'><br>
		
		<ol type='a' class='q{{q.id}}'>
		{% for a in q.answers %}
			
			<li id='answer{{a.id}}'>
			{% if a.correct %}
					<span class='option{{ forloop.counter }} answer correct'>{{a.answer}}</span>
					<input class='option{{ forloop.counter }} answerEdit' type='text' value='{{a.answer}}'> 
					<label class='correctOption'><input type='radio' class='correctOption' name='correct{{q.id}}' value='{{a.answer}}' checked>Correct Answer</label>
			{% else %}
                    <span class='option{{ forloop.counter }} answer'>{{a.answer}}</span>
					<input class='option{{ forloop.counter }} answerEdit' type='text' value='{{a.answer}}'>  
					<label class='correctOption'><input type='radio' class='correctOption' name='correct{{q.id}}' value='{{a.answer}}'>Correct Answer</label>
			{% endif %}
            </li>
			
		{% endfor %}
		</ol>
		</div>
		<br><br>
	{% endfor %}
	</div>
	
</div>
{% include "admin/dialogs.html" %}
{% include "admin/footer.html" %}